{"ast":null,"code":"\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Users = void 0;\n\nvar events_1 = require(\"events\");\n\nvar user_1 = require(\"../user\");\n\nvar util_1 = require(\"../util\");\n/**\n * @classdesc Container for known users\n * @fires Users#userUpdated\n */\n\n\nvar Users = function (_events_1$EventEmitte) {\n  (0, _inherits3.default)(Users, _events_1$EventEmitte);\n\n  function Users(services) {\n    (0, _classCallCheck3.default)(this, Users);\n\n    var _this = (0, _possibleConstructorReturn3.default)(this, (Users.__proto__ || (0, _getPrototypeOf2.default)(Users)).call(this));\n\n    _this.services = services;\n    _this.fifoStack = [];\n    _this.fifoStackMaxLength = 100;\n    _this.myself = new user_1.User(null, null, _this.services);\n\n    _this.myself.on('updated', function (args) {\n      return _this.emit('userUpdated', args);\n    });\n\n    _this.myself.on('userSubscribed', function () {\n      return _this.emit('userSubscribed', _this.myself);\n    });\n\n    _this.myself.on('userUnsubscribed', function () {\n      _this.emit('userUnsubscribed', _this.myself);\n\n      _this.myself._ensureFetched();\n    });\n\n    _this.services = services;\n    _this.subscribedUsers = new _map2.default();\n    _this.userUrlPromise = _this.services.session.getSessionLinks().then(function (links) {\n      _this.userUrl = links.usersUrl;\n      return _this.userUrl;\n    });\n\n    _this.services.session.getMaxUserInfosToSubscribe().then(function (maxUserInfosToSubscribe) {\n      _this.fifoStackMaxLength = maxUserInfosToSubscribe;\n    });\n\n    _this.services.session.getUsersData().then(function (data) {\n      _this.myself.identity = data.identity;\n      _this.myself.entityName = data.user;\n      return _this.myself._ensureFetched();\n    });\n\n    return _this;\n  }\n\n  (0, _createClass3.default)(Users, [{\n    key: \"handleUnsubscribeUser\",\n    value: function handleUnsubscribeUser(user) {\n      if (this.subscribedUsers.has(user.identity)) {\n        this.subscribedUsers.delete(user.identity);\n      }\n\n      var foundItemIndex = -1;\n      var foundItem = this.fifoStack.find(function (item, index) {\n        if (item == user.identity) {\n          foundItemIndex = index;\n          return true;\n        }\n\n        return false;\n      });\n\n      if (foundItem) {\n        this.fifoStack.splice(foundItemIndex, 1);\n      }\n\n      this.emit('userUnsubscribed', user);\n    }\n  }, {\n    key: \"handleSubscribeUser\",\n    value: function handleSubscribeUser(user) {\n      if (this.subscribedUsers.has(user.identity)) {\n        return;\n      }\n\n      if (this.fifoStack.length >= this.fifoStackMaxLength) {\n        this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe();\n      }\n\n      this.fifoStack.push(user.identity);\n      this.subscribedUsers.set(user.identity, user);\n      this.emit('userSubscribed', user);\n    }\n    /**\n     * Gets user, if it's in subscribed list - then return the user object from it,\n     * if not - then subscribes and adds user to the FIFO stack\n     * @returns {Promise<User>} Fully initialized user\n     */\n\n  }, {\n    key: \"getUser\",\n    value: function () {\n      var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(identity) {\n        var _this2 = this;\n\n        var entityName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n        var user;\n        return _regenerator2.default.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _context.next = 2;\n                return this.services.session.getUsersData();\n\n              case 2:\n                _context.next = 4;\n                return this.myself._ensureFetched();\n\n              case 4:\n                if (!(identity == this.myself.identity)) {\n                  _context.next = 6;\n                  break;\n                }\n\n                return _context.abrupt(\"return\", this.myself);\n\n              case 6:\n                user = this.subscribedUsers.get(identity);\n\n                if (user) {\n                  _context.next = 18;\n                  break;\n                }\n\n                if (entityName) {\n                  _context.next = 12;\n                  break;\n                }\n\n                _context.next = 11;\n                return this.getSyncUniqueName(identity);\n\n              case 11:\n                entityName = _context.sent;\n\n              case 12:\n                user = new user_1.User(identity, entityName, this.services);\n                user.on('updated', function (args) {\n                  return _this2.emit('userUpdated', args);\n                });\n                user.on('userSubscribed', function () {\n                  return _this2.handleSubscribeUser(user);\n                });\n                user.on('userUnsubscribed', function () {\n                  return _this2.handleUnsubscribeUser(user);\n                });\n                _context.next = 18;\n                return user._ensureFetched();\n\n              case 18:\n                return _context.abrupt(\"return\", user);\n\n              case 19:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function getUser(_x2) {\n        return _ref.apply(this, arguments);\n      }\n\n      return getUser;\n    }()\n    /**\n     * @returns {Promise<Array<User>>} returns list of subscribed User objects {@see User}\n     */\n\n  }, {\n    key: \"getSubscribedUsers\",\n    value: function () {\n      var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n        var users;\n        return _regenerator2.default.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return this.services.session.getUsersData();\n\n              case 2:\n                _context2.next = 4;\n                return this.myself._ensureFetched();\n\n              case 4:\n                users = [this.myself];\n                this.subscribedUsers.forEach(function (user) {\n                  return users.push(user);\n                });\n                return _context2.abrupt(\"return\", users);\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function getSubscribedUsers() {\n        return _ref2.apply(this, arguments);\n      }\n\n      return getSubscribedUsers;\n    }()\n    /**\n     * @returns {Promise<string>} User's sync unique name\n     */\n\n  }, {\n    key: \"getSyncUniqueName\",\n    value: function () {\n      var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(identity) {\n        var url, response;\n        return _regenerator2.default.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                url = new util_1.UriBuilder(this.userUrl).path(identity).build();\n                _context3.next = 3;\n                return this.services.network.get(url);\n\n              case 3:\n                response = _context3.sent;\n                return _context3.abrupt(\"return\", response.body.sync_unique_name);\n\n              case 5:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this);\n      }));\n\n      function getSyncUniqueName(_x3) {\n        return _ref3.apply(this, arguments);\n      }\n\n      return getSyncUniqueName;\n    }()\n  }]);\n  return Users;\n}(events_1.EventEmitter);\n\nexports.Users = Users;","map":{"version":3,"sources":["/Users/stefanpjanic/Desktop/mango_dev/node_modules/@twilio/conversations/browser/data/users.js"],"names":["_regenerator","require","_regenerator2","_interopRequireDefault","_asyncToGenerator2","_asyncToGenerator3","_map","_map2","_getPrototypeOf","_getPrototypeOf2","_classCallCheck2","_classCallCheck3","_createClass2","_createClass3","_possibleConstructorReturn2","_possibleConstructorReturn3","_inherits2","_inherits3","obj","__esModule","default","Object","defineProperty","exports","value","Users","events_1","user_1","util_1","_events_1$EventEmitte","services","_this","__proto__","call","fifoStack","fifoStackMaxLength","myself","User","on","args","emit","_ensureFetched","subscribedUsers","userUrlPromise","session","getSessionLinks","then","links","userUrl","usersUrl","getMaxUserInfosToSubscribe","maxUserInfosToSubscribe","getUsersData","data","identity","entityName","user","key","handleUnsubscribeUser","has","delete","foundItemIndex","foundItem","find","item","index","splice","handleSubscribeUser","length","get","shift","unsubscribe","push","set","_ref","mark","_callee","_this2","arguments","undefined","wrap","_callee$","_context","prev","next","abrupt","getSyncUniqueName","sent","stop","getUser","_x2","apply","_ref2","_callee2","users","_callee2$","_context2","forEach","getSubscribedUsers","_ref3","_callee3","url","response","_callee3$","_context3","UriBuilder","path","build","network","body","sync_unique_name","_x3","EventEmitter"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _regenerator = require(\"babel-runtime/regenerator\");\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require(\"babel-runtime/helpers/asyncToGenerator\");\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _map = require(\"babel-runtime/core-js/map\");\n\nvar _map2 = _interopRequireDefault(_map);\n\nvar _getPrototypeOf = require(\"babel-runtime/core-js/object/get-prototype-of\");\n\nvar _getPrototypeOf2 = _interopRequireDefault(_getPrototypeOf);\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _possibleConstructorReturn2 = require(\"babel-runtime/helpers/possibleConstructorReturn\");\n\nvar _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);\n\nvar _inherits2 = require(\"babel-runtime/helpers/inherits\");\n\nvar _inherits3 = _interopRequireDefault(_inherits2);\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Users = void 0;\nvar events_1 = require(\"events\");\nvar user_1 = require(\"../user\");\nvar util_1 = require(\"../util\");\n/**\n * @classdesc Container for known users\n * @fires Users#userUpdated\n */\n\nvar Users = function (_events_1$EventEmitte) {\n    (0, _inherits3.default)(Users, _events_1$EventEmitte);\n\n    function Users(services) {\n        (0, _classCallCheck3.default)(this, Users);\n\n        var _this = (0, _possibleConstructorReturn3.default)(this, (Users.__proto__ || (0, _getPrototypeOf2.default)(Users)).call(this));\n\n        _this.services = services;\n        _this.fifoStack = [];\n        _this.fifoStackMaxLength = 100;\n        _this.myself = new user_1.User(null, null, _this.services);\n        _this.myself.on('updated', function (args) {\n            return _this.emit('userUpdated', args);\n        });\n        _this.myself.on('userSubscribed', function () {\n            return _this.emit('userSubscribed', _this.myself);\n        });\n        _this.myself.on('userUnsubscribed', function () {\n            _this.emit('userUnsubscribed', _this.myself);\n            _this.myself._ensureFetched();\n        });\n        _this.services = services;\n        _this.subscribedUsers = new _map2.default();\n        _this.userUrlPromise = _this.services.session.getSessionLinks().then(function (links) {\n            _this.userUrl = links.usersUrl;\n            return _this.userUrl;\n        });\n        _this.services.session.getMaxUserInfosToSubscribe().then(function (maxUserInfosToSubscribe) {\n            _this.fifoStackMaxLength = maxUserInfosToSubscribe;\n        });\n        _this.services.session.getUsersData().then(function (data) {\n            _this.myself.identity = data.identity;\n            _this.myself.entityName = data.user;\n            return _this.myself._ensureFetched();\n        });\n        return _this;\n    }\n\n    (0, _createClass3.default)(Users, [{\n        key: \"handleUnsubscribeUser\",\n        value: function handleUnsubscribeUser(user) {\n            if (this.subscribedUsers.has(user.identity)) {\n                this.subscribedUsers.delete(user.identity);\n            }\n            var foundItemIndex = -1;\n            var foundItem = this.fifoStack.find(function (item, index) {\n                if (item == user.identity) {\n                    foundItemIndex = index;\n                    return true;\n                }\n                return false;\n            });\n            if (foundItem) {\n                this.fifoStack.splice(foundItemIndex, 1);\n            }\n            this.emit('userUnsubscribed', user);\n        }\n    }, {\n        key: \"handleSubscribeUser\",\n        value: function handleSubscribeUser(user) {\n            if (this.subscribedUsers.has(user.identity)) {\n                return;\n            }\n            if (this.fifoStack.length >= this.fifoStackMaxLength) {\n                this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe();\n            }\n            this.fifoStack.push(user.identity);\n            this.subscribedUsers.set(user.identity, user);\n            this.emit('userSubscribed', user);\n        }\n        /**\n         * Gets user, if it's in subscribed list - then return the user object from it,\n         * if not - then subscribes and adds user to the FIFO stack\n         * @returns {Promise<User>} Fully initialized user\n         */\n\n    }, {\n        key: \"getUser\",\n        value: function () {\n            var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee(identity) {\n                var _this2 = this;\n\n                var entityName = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n                var user;\n                return _regenerator2.default.wrap(function _callee$(_context) {\n                    while (1) {\n                        switch (_context.prev = _context.next) {\n                            case 0:\n                                _context.next = 2;\n                                return this.services.session.getUsersData();\n\n                            case 2:\n                                _context.next = 4;\n                                return this.myself._ensureFetched();\n\n                            case 4:\n                                if (!(identity == this.myself.identity)) {\n                                    _context.next = 6;\n                                    break;\n                                }\n\n                                return _context.abrupt(\"return\", this.myself);\n\n                            case 6:\n                                user = this.subscribedUsers.get(identity);\n\n                                if (user) {\n                                    _context.next = 18;\n                                    break;\n                                }\n\n                                if (entityName) {\n                                    _context.next = 12;\n                                    break;\n                                }\n\n                                _context.next = 11;\n                                return this.getSyncUniqueName(identity);\n\n                            case 11:\n                                entityName = _context.sent;\n\n                            case 12:\n                                user = new user_1.User(identity, entityName, this.services);\n                                user.on('updated', function (args) {\n                                    return _this2.emit('userUpdated', args);\n                                });\n                                user.on('userSubscribed', function () {\n                                    return _this2.handleSubscribeUser(user);\n                                });\n                                user.on('userUnsubscribed', function () {\n                                    return _this2.handleUnsubscribeUser(user);\n                                });\n                                _context.next = 18;\n                                return user._ensureFetched();\n\n                            case 18:\n                                return _context.abrupt(\"return\", user);\n\n                            case 19:\n                            case \"end\":\n                                return _context.stop();\n                        }\n                    }\n                }, _callee, this);\n            }));\n\n            function getUser(_x2) {\n                return _ref.apply(this, arguments);\n            }\n\n            return getUser;\n        }()\n        /**\n         * @returns {Promise<Array<User>>} returns list of subscribed User objects {@see User}\n         */\n\n    }, {\n        key: \"getSubscribedUsers\",\n        value: function () {\n            var _ref2 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2() {\n                var users;\n                return _regenerator2.default.wrap(function _callee2$(_context2) {\n                    while (1) {\n                        switch (_context2.prev = _context2.next) {\n                            case 0:\n                                _context2.next = 2;\n                                return this.services.session.getUsersData();\n\n                            case 2:\n                                _context2.next = 4;\n                                return this.myself._ensureFetched();\n\n                            case 4:\n                                users = [this.myself];\n\n                                this.subscribedUsers.forEach(function (user) {\n                                    return users.push(user);\n                                });\n                                return _context2.abrupt(\"return\", users);\n\n                            case 7:\n                            case \"end\":\n                                return _context2.stop();\n                        }\n                    }\n                }, _callee2, this);\n            }));\n\n            function getSubscribedUsers() {\n                return _ref2.apply(this, arguments);\n            }\n\n            return getSubscribedUsers;\n        }()\n        /**\n         * @returns {Promise<string>} User's sync unique name\n         */\n\n    }, {\n        key: \"getSyncUniqueName\",\n        value: function () {\n            var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(identity) {\n                var url, response;\n                return _regenerator2.default.wrap(function _callee3$(_context3) {\n                    while (1) {\n                        switch (_context3.prev = _context3.next) {\n                            case 0:\n                                url = new util_1.UriBuilder(this.userUrl).path(identity).build();\n                                _context3.next = 3;\n                                return this.services.network.get(url);\n\n                            case 3:\n                                response = _context3.sent;\n                                return _context3.abrupt(\"return\", response.body.sync_unique_name);\n\n                            case 5:\n                            case \"end\":\n                                return _context3.stop();\n                        }\n                    }\n                }, _callee3, this);\n            }));\n\n            function getSyncUniqueName(_x3) {\n                return _ref3.apply(this, arguments);\n            }\n\n            return getSyncUniqueName;\n        }()\n    }]);\n    return Users;\n}(events_1.EventEmitter);\n\nexports.Users = Users;"]},"metadata":{},"sourceType":"script"}