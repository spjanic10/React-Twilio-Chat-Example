{"ast":null,"code":"\"use strict\";\n\nvar _classCallCheck = require(\"/Users/stefanpjanic/Desktop/mango_dev/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/stefanpjanic/Desktop/mango_dev/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar logger_1 = require(\"./logger\");\n\nfunction byteLength(s) {\n  var escstr = encodeURIComponent(s);\n  var binstr = escstr.replace(/%([0-9A-F]{2})/g, function (match, p1) {\n    return String.fromCharCode('0x' + p1);\n  });\n  return binstr.length;\n}\n\nfunction stringToUint8Array(s) {\n  var escstr = encodeURIComponent(s);\n  var binstr = escstr.replace(/%([0-9A-F]{2})/g, function (match, p1) {\n    return String.fromCharCode('0x' + p1);\n  });\n  var ua = new Uint8Array(binstr.length);\n  Array.prototype.forEach.call(binstr, function (ch, i) {\n    ua[i] = ch.charCodeAt(0);\n  });\n  return ua;\n}\n\nfunction uint8ArrayToString(ua) {\n  var binstr = Array.prototype.map.call(ua, function (ch) {\n    return String.fromCharCode(ch);\n  }).join('');\n  var escstr = binstr.replace(/(.)/g, function (m, p) {\n    var code = p.charCodeAt(0).toString(16).toUpperCase();\n\n    if (code.length < 2) {\n      code = '0' + code;\n    }\n\n    return '%' + code;\n  });\n  return decodeURIComponent(escstr);\n}\n\nfunction getJsonObject(array) {\n  return JSON.parse(uint8ArrayToString(array));\n}\n\nfunction getMagic(buffer) {\n  var strMagic = '';\n  var idx = 0;\n\n  for (; idx < buffer.length; ++idx) {\n    var chr = String.fromCharCode(buffer[idx]);\n    strMagic += chr;\n\n    if (chr === '\\r') {\n      idx += 2;\n      break;\n    }\n  }\n\n  var magics = strMagic.split(' ');\n  return {\n    size: idx,\n    protocol: magics[0],\n    version: magics[1],\n    headerSize: Number(magics[2])\n  };\n}\n\nvar Parser = /*#__PURE__*/function () {\n  function Parser() {\n    _classCallCheck(this, Parser);\n  }\n\n  _createClass(Parser, null, [{\n    key: \"parse\",\n    value: function parse(message) {\n      var fieldMargin = 2;\n      var dataView = new Uint8Array(message);\n      var magic = getMagic(dataView);\n\n      if (magic.protocol !== 'TWILSOCK' || magic.version !== 'V3.0') {\n        logger_1.log.error(\"unsupported protocol: \".concat(magic.protocol, \" ver \").concat(magic.version)); //throw new Error('Unsupported protocol');\n        //this.fsm.unsupportedProtocol();\n\n        return;\n      }\n\n      var header = null;\n\n      try {\n        header = getJsonObject(dataView.subarray(magic.size, magic.size + magic.headerSize));\n      } catch (e) {\n        logger_1.log.error('failed to parse message header', e, message); //throw new Error('Failed to parse message');\n        //this.fsm.protocolError();\n\n        return;\n      }\n\n      logger_1.log.debug('message received: ', header.method);\n      logger_1.log.trace('message received: ', header);\n      var payload = null;\n\n      if (header.payload_size > 0) {\n        var payloadOffset = fieldMargin + magic.size + magic.headerSize;\n        var payloadSize = header.payload_size;\n\n        if (!header.hasOwnProperty('payload_type') || header.payload_type.indexOf('application/json') === 0) {\n          try {\n            payload = getJsonObject(dataView.subarray(payloadOffset, payloadOffset + payloadSize));\n          } catch (e) {\n            logger_1.log.error('failed to parse message body', e, message); //this.fsm.protocolError();\n\n            return;\n          }\n        } else if (header.payload_type.indexOf('text/plain') === 0) {\n          payload = uint8ArrayToString(dataView.subarray(payloadOffset, payloadOffset + payloadSize));\n        }\n      }\n\n      return {\n        method: header.method,\n        header: header,\n        payload: payload\n      };\n    }\n  }, {\n    key: \"createPacket\",\n    value: function createPacket(header) {\n      var payloadString = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';\n      header.payload_size = byteLength(payloadString); // eslint-disable-line camelcase\n\n      var headerString = JSON.stringify(header) + '\\r\\n';\n      var magicString = 'TWILSOCK V3.0 ' + (byteLength(headerString) - 2) + '\\r\\n';\n      logger_1.log.debug('send request:', magicString + headerString + payloadString);\n      var message = stringToUint8Array(magicString + headerString + payloadString);\n      return message.buffer;\n    }\n  }]);\n\n  return Parser;\n}();\n\nexports.Parser = Parser;","map":{"version":3,"sources":["/Users/stefanpjanic/Desktop/mango_dev/node_modules/twilio-notifications/node_modules/twilsock/lib/parser.js"],"names":["Object","defineProperty","exports","value","logger_1","require","byteLength","s","escstr","encodeURIComponent","binstr","replace","match","p1","String","fromCharCode","length","stringToUint8Array","ua","Uint8Array","Array","prototype","forEach","call","ch","i","charCodeAt","uint8ArrayToString","map","join","m","p","code","toString","toUpperCase","decodeURIComponent","getJsonObject","array","JSON","parse","getMagic","buffer","strMagic","idx","chr","magics","split","size","protocol","version","headerSize","Number","Parser","message","fieldMargin","dataView","magic","log","error","header","subarray","e","debug","method","trace","payload","payload_size","payloadOffset","payloadSize","hasOwnProperty","payload_type","indexOf","payloadString","headerString","stringify","magicString"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst logger_1 = require(\"./logger\");\nfunction byteLength(s) {\n    let escstr = encodeURIComponent(s);\n    let binstr = escstr.replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1));\n    return binstr.length;\n}\nfunction stringToUint8Array(s) {\n    let escstr = encodeURIComponent(s);\n    let binstr = escstr.replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1));\n    let ua = new Uint8Array(binstr.length);\n    Array.prototype.forEach.call(binstr, (ch, i) => { ua[i] = ch.charCodeAt(0); });\n    return ua;\n}\nfunction uint8ArrayToString(ua) {\n    let binstr = Array.prototype.map.call(ua, ch => String.fromCharCode(ch)).join('');\n    let escstr = binstr.replace(/(.)/g, (m, p) => {\n        let code = p.charCodeAt(0).toString(16).toUpperCase();\n        if (code.length < 2) {\n            code = '0' + code;\n        }\n        return '%' + code;\n    });\n    return decodeURIComponent(escstr);\n}\nfunction getJsonObject(array) {\n    return JSON.parse(uint8ArrayToString(array));\n}\nfunction getMagic(buffer) {\n    let strMagic = '';\n    let idx = 0;\n    for (; idx < buffer.length; ++idx) {\n        const chr = String.fromCharCode(buffer[idx]);\n        strMagic += chr;\n        if (chr === '\\r') {\n            idx += 2;\n            break;\n        }\n    }\n    const magics = strMagic.split(' ');\n    return {\n        size: idx,\n        protocol: magics[0],\n        version: magics[1],\n        headerSize: Number(magics[2])\n    };\n}\nclass Parser {\n    constructor() { }\n    static parse(message) {\n        const fieldMargin = 2;\n        const dataView = new Uint8Array(message);\n        const magic = getMagic(dataView);\n        if (magic.protocol !== 'TWILSOCK' || magic.version !== 'V3.0') {\n            logger_1.log.error(`unsupported protocol: ${magic.protocol} ver ${magic.version}`);\n            //throw new Error('Unsupported protocol');\n            //this.fsm.unsupportedProtocol();\n            return;\n        }\n        let header = null;\n        try {\n            header = getJsonObject(dataView.subarray(magic.size, magic.size + magic.headerSize));\n        }\n        catch (e) {\n            logger_1.log.error('failed to parse message header', e, message);\n            //throw new Error('Failed to parse message');\n            //this.fsm.protocolError();\n            return;\n        }\n        logger_1.log.debug('message received: ', header.method);\n        logger_1.log.trace('message received: ', header);\n        let payload = null;\n        if (header.payload_size > 0) {\n            const payloadOffset = fieldMargin + magic.size + magic.headerSize;\n            const payloadSize = header.payload_size;\n            if (!header.hasOwnProperty('payload_type') || header.payload_type.indexOf('application/json') === 0) {\n                try {\n                    payload = getJsonObject(dataView.subarray(payloadOffset, payloadOffset + payloadSize));\n                }\n                catch (e) {\n                    logger_1.log.error('failed to parse message body', e, message);\n                    //this.fsm.protocolError();\n                    return;\n                }\n            }\n            else if (header.payload_type.indexOf('text/plain') === 0) {\n                payload = uint8ArrayToString(dataView.subarray(payloadOffset, payloadOffset + payloadSize));\n            }\n        }\n        return { method: header.method, header, payload };\n    }\n    static createPacket(header, payloadString = '') {\n        header.payload_size = byteLength(payloadString); // eslint-disable-line camelcase\n        let headerString = JSON.stringify(header) + '\\r\\n';\n        let magicString = 'TWILSOCK V3.0 ' + (byteLength(headerString) - 2) + '\\r\\n';\n        logger_1.log.debug('send request:', magicString + headerString + payloadString);\n        let message = stringToUint8Array(magicString + headerString + payloadString);\n        return message.buffer;\n    }\n}\nexports.Parser = Parser;\n"]},"metadata":{},"sourceType":"script"}